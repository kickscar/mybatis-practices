03. SqlSessionFactory 생성

## 03\. SqlSessionFactory 생성

MyBatis 설정의 대부분은 SqlSessionFactory의 생성하기 위한 설정으로 다음의 6가지를 설정한다.

1.  Properties
2.  Settings
3.  Environments
    - Transaction Manager
    - DataSource
4.  Type Aliases
5.  Type Handlers
6.  Mappers

#### 1\. 설정 파일

1. XML 형식의 설정 파일은 적당한 이름으로 클래스 패스에 위치하는 것이 보통이다.
2. resource 형태인 이 설정 파일을 애플리케이션에서 InputStream으로 연결하여 SqlSessionFactory 생성자에 전달해야 한다.

\[예제 Ex01Test\]

```java
public class Ex01Test {
   @Test
    public void shoudThrowIOException() {
        assertThrows(IOException.class, () -> {
                InputStream inputStream = Resources.getResourceAsStream("_03/config/none.xml");
        });
    }

    @Test
    public void shoudSqlSessionFacoryNotNull() throws Throwable {
        InputStream inputStream = Resources.getResourceAsStream("_03/config/ex02.xml");
        SqlSessionFactory sqlSessionFactory = new SqlSessionFactoryBuilder().build(inputStream);
        assertNotNull(sqlSessionFactory);
    }
}
```

1.  설정 파일이 존재하지 않는 경우 IOException이 발생한다.
2.  설정 파일이 존재하는 경우 SqlSessionFactory 객체가 생성된다.

설정 파일 ex02.xml에는 아무런 설정이 되어 있지 않지만 정상적인 MyBatis 설정 파일이다. 설정 항목을 하나씩 추가해 보면서 항목의 내용도 알아보자.

#### 2\. environments

SQL문이 실행되기 위한 환경을 의미하며 트랜잭션 매니저와 데이터베이스 연결을 위한 DataSource 설정을 한다. 대부분의 MyBatis 실행 환경에서 설정하는 내용이다. Spring Framework(스프링 컨테이너)와 같은 실행 환경에서도 동일하게 적용될 수 있지만 MyBatis에서 지원하는 스프링 컨테이너의 빈 생성/주입 방식의 설정을 따르게 되면 설정하지 않는다.

1. &lt;environment&gt;
   &lt;environments&gt; 안에 여러 &lt;environment&gt;설정이 가능하다. 한 애플리케이션에서 여러 데이터베이스를 사용할 때 필요하지만 개발용 데이터베이스와 서비스 데이테베이스를 구분할 때도 사용할 수 있다. 적용할 environment의 id를 SqlSessionFactory를 생성할 때 넘겨주면 된다. id를 생략하면 &lt;environments&gt;의 default 속성에 설정한 id의 environment가 적용된다.
   
   [예제 Ex02Test]
   ```java
   public class Ex02Test {
    @Test
    public void shoudEnvironmentIdDevel() throws Throwable {
        InputStream inputStream = Resources.getResourceAsStream("_03/config/ex02.xml");
        SqlSessionFactory sqlSessionFactory = new SqlSessionFactoryBuilder().build(inputStream, "devel");

        assertEquals("devel", sqlSessionFactory.getConfiguration().getEnvironment().getId());
    }

    @Test
    public void shoudDefaultEnvironmentIdDevel() throws Throwable {
        InputStream inputStream = Resources.getResourceAsStream("_03/config/ex02.xml");
        SqlSessionFactory sqlSessionFactory = new SqlSessionFactoryBuilder().build(inputStream);

        assertEquals("devel", sqlSessionFactory.getConfiguration().getEnvironment().getId());
   	}
   }
   ```
   1. ex02.xml 설정에 id가 각각 "devel", "production"인 두 environment를 설정하였다.
   2. 첫 번째 테스트는 "devel"를 명시하여 생성된 SqlSessionFactory 내부의 environment 객체의 id를 확인해 본다.
   3. 두 번째 테스트는 environment id를 명시하지 않고 생성된 environment의 id가 "devel"인지 확인하는 테스트이다.

2. &lt;dataSource&gt;
   &lt;environments&gt;는 반드시 데이터베이스 연결을 위해 &lt;dataSource&gt;를 설정해야 한다. type 속성은 다음과 같은 값을 설정할 수 있다.
   1. UNPOOLED
   	  Connection Pool를 운용하지 않는다.
   2. POOLED
   	  Connection Pool를 운용한다.	
   3. JNDI
      WAS에 설정하는 JNDI 데이터소스에서 커넥션을 가져오도록 설정한다.
  
   [예제 Ex03Test]
   ```java
   public class Ex03Test {
    @Test
    public void shoudConnectionNotNull() throws Throwable {
        InputStream inputStream = Resources.getResourceAsStream("_03/config/ex03.xml");
        SqlSessionFactory sqlSessionFactory = new SqlSessionFactoryBuilder().build(inputStream);

        assertNotNull(sqlSessionFactory.getConfiguration().getEnvironment().getDataSource().getConnection());
    }
   }
   ```
   1. 데이테베이스 연결에 문제가 있으면 dataSource가 반환하는 Connection은 null이기 때문에 데이터베이스 연결을 테스트할 수 있다.
  
3. &lt;transactionManager&gt;