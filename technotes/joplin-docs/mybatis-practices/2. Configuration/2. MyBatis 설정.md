2. MyBatis 설정

## SqlSessionFactory 생성
 MyBatis 설정은

1. SqlSessionFactory의 생성하기 위한 설정(MyBatis 설정)
2. SQL Mapper 설정

이렇게 두 가지이다. SQL Mapper 설정은 뒤에서 자세히 다룰 것이다. 여기서는 SqlSessionFactory 생성을 위해 필요한 MyBatis 설정을 살펴본다. MyBatis 설정은 다음 6가지 주요 항목들을 설정한다.

1.  properties
    - property
2.  settings
    - setting
3.  typeAliases
    - typeAlias
    - package
4.  typeHandlers
    - typeHandler
5.  environments
    - environment
        - transactionManager
        - dataSource
6.  mappers
    - mapper
    - package

## 설정 파일

1.  설정 파일의 이름에는 제약사항이 없다. XML 형식의 설정 파일을 클래스패스에 둔다.
2.  resource 형태인 설정 파일을 애플리케이션에서 InputStream으로 연결한다. 그리고 SqlSessionFactory를 생성할 때 생성자에 InputStream를 전달한다.

\[예제 Ex01\]

```java
public class Ex01 {
   @Test
    public void shoudThrowIOException() {
        assertThrows(IOException.class, () -> {
                InputStream inputStream = Resources.getResourceAsStream("_03/config/none.xml");
        });
    }

    @Test
    public void shoudSqlSessionFacoryNotNull() throws Throwable {
        InputStream inputStream = Resources.getResourceAsStream("_03/config/ex02.xml");
        SqlSessionFactory sqlSessionFactory = new SqlSessionFactoryBuilder().build(inputStream);
        assertNotNull(sqlSessionFactory);
    }
}
```

1.  설정 파일이 존재하지 않는 경우 IOException이 발생한다.
2.  설정 파일이 존재하는 경우 SqlSessionFactory 객체가 생성된다.
    설정 파일 ex02.xml에는 아무런 설정이 되어 있지 않다. 하지만 정상적인 MyBatis 설정 파일이다. 설정 항목을 하나씩 추가해 보면서 그 내용도 살펴본다.

## environments

environment는 SQL문이 실행되기 위한 환경을 의미한다. 트랜잭션 매니저와 데이터베이스 연결을 위해 DataSource 설정을 한다. 대부분의 MyBatis 실행 환경에서 설정하는 항목이다. environment는 Spring Framework(스프링 컨테이너)와 같은 실행 환경에서도 설정될 수 있는데 이 때는 MyBatis가 지원하는 빈 생성/주입 방식으로 설정하기 때문에 생략된다.

1.  &lt;environment&gt;
    여러 &lt;environment&gt;설정을 &lt;environments&gt; 안에 한다. 한 애플리케이션에서 여러 데이터베이스를 사용할 때 필요하지만 개발용 데이터베이스와 실제 서비스용 데이테베이스를 따로 설정할 수도 있다. 여러 environment가 설정되었다면 SqlSessionFactory를 생성할 때 적용할 environment의 id를 파라미터로 전달한다. id를 생략하면 &lt;environments&gt;의 default 속성에 설정한 id의 environment가 적용된다.
    
    \[예제 Ex02\]
    
    ```java
    public class Ex02 {
     @Test
     public void shoudEnvironmentIdDevel() throws Throwable {
         InputStream inputStream = Resources.getResourceAsStream("_03/config/ex02.xml");
         SqlSessionFactory sqlSessionFactory = new SqlSessionFactoryBuilder().build(inputStream, "devel");
    
         assertEquals("devel", sqlSessionFactory.getConfiguration().getEnvironment().getId());
     }
    
     @Test
     public void shoudDefaultEnvironmentIdDevel() throws Throwable {
         InputStream inputStream = Resources.getResourceAsStream("_03/config/ex02.xml");
         SqlSessionFactory sqlSessionFactory = new SqlSessionFactoryBuilder().build(inputStream);
    
         assertEquals("devel", sqlSessionFactory.getConfiguration().getEnvironment().getId());
        }
    }
    ```
    1.  ex02.xml 설정에 id가 각각 "devel", "production"인 두 environment를 설정하였다.
    2.  첫 번째 테스트는 "devel"를 명시하여 생성된 SqlSessionFactory 내부의 environment id를 확인하는 테스트다.
    3.  두 번째 테스트는 environment id를 명시하지 않고 생성된 environment의 id가 efault 속성에 설정한 id인 "devel"인지 확인하는 테스트다.

2.  &lt;dataSource&gt;
    &lt;environment&gt;안에는 반드시 데이터베이스 연결을 위해 &lt;dataSource&gt;를 설정해야 한다. type 속성은 다음과 같은 값을 설정할 수 있다.
    
    1.  UNPOOLED
        Connection Pool를 운용하지 않는다.
    2.  POOLED
        Connection Pool를 운용한다.
    3.  JNDI
        WAS에 설정하는 JNDI 데이터소스에서 커넥션을 가져오도록 설정한다.
    
    \[예제 Ex03\]
    
    ```java
    public class Ex03 {
     @Test
     public void shoudConnectionNotNull() throws Throwable {
         InputStream inputStream = Resources.getResourceAsStream("_03/config/ex03.xml");
         SqlSessionFactory sqlSessionFactory = new SqlSessionFactoryBuilder().build(inputStream);
    
         assertNotNull(sqlSessionFactory.getConfiguration().getEnvironment().getDataSource().getConnection());
     }
    }
    ```
    1.	dataSource가 반환하는 Connection 객체의 null 여부로 데이터베이스 연결을 테스트한다.
    
3.  &lt;transactionManager&gt;
    트랜잭션 관리자를 설정한다. 다음 두 개의 트랜잭션 관리자를 설정할 수 있다.
    
    1.  JDBC 트랜잭션 관리자
        애플리케이션에서 직접 관리해야 한다. Tomcat 같은 WAS는 EJB Container기능이 없기 때문에 이 설정밖에 사용 못한다.
    2.  Managed 트랜잭션 관리자
        EJB 콘테이너 기능이 있는 WAS를 사용하면 이 설정을 통해 WAS의 트랜잭션 관리하에 애플리케이션을 작성할 수 있다.

## mappers

MyBatis ORM은 애플리케이션에서 실행하는 SQL문의 파라미터와 select SQL문의 결과를 자바 객체에 각각 매핑한다. 매퍼(Mapper) 파일에 그 설정을 하게 되는 데 &lt;mappers&gt;에 여러 매퍼 파일을 &lt;mapper&gt;로 설정한다. mapper 설정은 2장 3장에서 자세히 다룬다. 여기서는 매퍼 파일의 몇가지 로딩 방식을 설명한다. 로딩 방식은 다음 속성들로 설정할 수 있다.

1.  resource 속성
    가장 일반적인 방식으로 클래스 패스에 있는 매퍼 파일을 지정한다.
2.  url 속성
    절대 경로의 파일시스템 내의 매퍼 파일이나 웹 URL에 존재하는 매퍼 파일 설정에 사용한다.
3.  class
    매퍼 파일을 지정하는 것은 아니고 매퍼 파일과 함께 매핑에 사용하는 매퍼 인터페이스를 지정한다.

그리고 매퍼 인터페이스를 매퍼 파일과 함께 사용할 때 &lt;package&gt;를 사용하여 매퍼 인터페이스가 위치하는 패키지를 지정할 수 있다. 간단한 예제로 mappers 설정을 직접 확인해 보자. 예제는 인메모리디비(h2)에 book 테이블을 생성하고 매퍼 파일(boom.xml)의 insert SQL문을 실행 시킨다. 그리고 그 결과를 테스트한다. 테스트를 위해 테이블을 생성하는 부분이 추가되었는데 지금은 매퍼 파일 설정만 이해하면 된다.

\[예제 Ex04\]

```java
public class Ex04 {
    private static SqlSessionFactory sqlSessionFactory;

    @BeforeAll
    public static void setup() throws Throwable {
        sqlSessionFactory = new SqlSessionFactoryBuilder().build(Resources.getResourceAsStream("_03/config/ex04.xml"));

        DataSource dataSource = sqlSessionFactory.getConfiguration().getEnvironment().getDataSource();
        ScriptRunner scriptRunner = new ScriptRunner(dataSource.getConnection());
        scriptRunner.runScript(Resources.getResourceAsReader("_03/sql/ddl.sql"));
    }

    @Test
    public void testInsertSQL()  {
        SqlSession session = sqlSessionFactory.openSession();

        int count = session.insert("book.insert", "마이바티스 연습");
        assertEquals(1, count);
    }
}
```

\[예제 ex04-book.xml\]

```xml
<mapper namespace="book">
    <insert id="insert" parameterType="string">
        insert into book values(null, #{name })
    </insert>
</mapper>
```

1.  @BeforAll이 달린 static 메소드에서 테스트 전의 초기 작업을 한다. SqlSessionFactory를 생성한 후, ScriptRunner는 SqlSessionFactory 생성에 사용된 DataSource을 사용하여 테스트 테이블 생성을 위해 지정된 DDL을 실행한다.
2.  생성된 SqlSessionFactory로 부터 SQL 실행을 위해 SqlSession 객체를 얻는다. SqlSession의 insert 메소드로 insert SQL문을 실행한다. SQL Mapper에 로딩된 SQL문의 id와 SQL 매핑 파라미터인 book의 name을 함께 전달한다.
3.  실행 결과는 inser된 row의 카운트이다. 이 카운트로 테스트 통과 조건을 설정하였다.

## properties

설정에 사용되는 값들을 프로퍼티로 다룰 수 있게 한다. 프로퍼티는 프로그램 코드의 변수처럼 반복되는 값들을 하나의 이름(키)로 다룰 수 있어 수정과 관리가 편리하다. &lt;property&gt;에 name과 value 속성으로 이름과 값을 추가하여 사용하면 된다. 설정 파일에 개별적인 프로퍼티들을 정의하고 사용할 수 있지만 외부 자바 properties 파일에 프로퍼티들을 모아 정의하고 import하여 사용하는 방식을 추천한다. 예제를 살펴 보자.

\[예제 ex05.xml\]

```xml
<configuration>
    <properties resource="_02/properties/jdbc.properties" />

    <environments default="devel">
        <environment id="devel">
            <transactionManager type="JDBC" />
            <dataSource type="POOLED">
                <property name="driver" value="${jdbc.driverClassName}"/>
                <property name="url" value="${jdbc.url}"/>
                <property name="username" value="${jdbc.username}"/>
                <property name="password" value="${jdbc.password}"/>
            </dataSource>
        </environment>
    </environments>
</configuration>
```

\[예제 jdbc.properties\]

```properties
jdbc.driverClassName=org.h2.Driver
jdbc.url=jdbc:h2:mem:test;DB_CLOSE_DELAY=-1;MODE=MYSQL
jdbc.username=sa
jdbc.password=
```

1.  이 예제의 테스트 코드는 연결 테스트를 했던 Ex03.java 와 같다. 
2.  설정 파일의 &lt;properties&gt;의 resource 속성으로 jdbc.properties 파일을 import 한다.
3.  &lt;dataSource&gt;에서 import된 프로퍼티들을 사용하여 연결 설정을 한다.
4.  데이터베이스 연결 정보 관리는 jdbc.properties 파일만 관리하면 된다.

## typeAliases

다음은 mapper 파일에서 SQL문의 parameter와 result를 매핑하는 예제이다.

```xml
<select id="findByNo" parameterType="long" resultType="_02.domain.Book">
 select no, name from book where no = #{no }
</select>
```

resultType 속성에 결과를 매핑할 패키지 경로를 포함한 클래스의 이름을 사용한다. 이 예제에서는 _02.domain.Book 이다. &lt;typeAlias&gt;를 사용하면 패키지 경로를 다 써주는 대신 생략이 가능하다.

\[예제 ex06.xml\]

```xml
<configuration>
.
.
    <typeAliases>
        <typeAlias type="_02.domain.Book" alias="book" />
    </typeAliases>
.
.
    <mappers>
        <mapper resource="_02/config/mappers/ex06-book.xml" />
    </mappers>
.
.
</configuration>
```

\[예제 ex06-book.xml\]

```xml
<mapper namespace="book">
.
.
    <select id="findByNo" parameterType="long" resultType="book">
        select no, name from book where no = #{no }
    </select>
.
.
</mapper>
```

1.  매퍼 파일로 설정되어 있는 ex06-book.xml의 SQL 매핑을 보면 resultType 속성에 패키지 경로를 생략하고 alias로 지정된 book만 지정하였다.
2.  테스트 코드는 insert한 book의 name으로 검색해서 그 결과를 Book의 객체로 매핑하여 받고 반환된 Book 객체의 name을 비교한다.